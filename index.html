<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线编辑器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
</head>
<body>
    <style>
        .editor { width: 33.33%; float: left; height: 50vh; }
        .preview { width: 100%; height: 50vh; }
        #buttons { text-align: center; margin-top: 10px; }
    </style>

    <textarea id="html" class="editor" placeholder="HTML"></textarea>
    <textarea id="css" class="editor" placeholder="CSS"></textarea>
    <textarea id="js" class="editor" placeholder="JS"></textarea>

    <iframe id="preview" class="preview"></iframe>
    
    <div id="buttons">
        <button onclick="formatCode()">格式化代码</button>
        <button onclick="exportCode()">导出</button>
        <button onclick="saveCode()">保存</button>
        <button onclick="loadCode()">恢复</button>
        <button onclick="changeTheme()">切换主题</button>
        <button onclick="openPreview()">预览窗口分离</button>
    </div>

    <script>
        let htmlEditor = CodeMirror.fromTextArea(document.getElementById("html"), {
            mode: "xml",
            theme: "default",
            lineNumbers: true,
            autoCloseTags: true
        });

        let cssEditor = CodeMirror.fromTextArea(document.getElementById("css"), {
            mode: "css",
            theme: "default",
            lineNumbers: true,
            autoCloseBrackets: true
        });

        let jsEditor = CodeMirror.fromTextArea(document.getElementById("js"), {
            mode: "javascript",
            theme: "default",
            lineNumbers: true,
            autoCloseBrackets: true
        });

        function updatePreview() {
            let html = htmlEditor.getValue();
            let css = "<style>" + cssEditor.getValue() + "</style>";
            let js = "<script>" + jsEditor.getValue() + "<\/script>";
            let iframe = document.getElementById("preview");
            iframe.srcdoc = html + css + js;
        }

        htmlEditor.on("change", updatePreview);
        cssEditor.on("change", updatePreview);
        jsEditor.on("change", updatePreview);

        function formatCode() {
            htmlEditor.setValue(html_beautify(htmlEditor.getValue()));
            cssEditor.setValue(css_beautify(cssEditor.getValue()));
            jsEditor.setValue(js_beautify(jsEditor.getValue()));
        }

        function exportCode() {
            let html = htmlEditor.getValue();
            let css = cssEditor.getValue();
            let js = jsEditor.getValue();
            let blob = new Blob([html + "<style>" + css + "</style><script>" + js + "</script>"], { type: "text/html" });
            let a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "code.html";
            a.click();
        }

        function saveCode() {
            localStorage.setItem("html", htmlEditor.getValue());
            localStorage.setItem("css", cssEditor.getValue());
            localStorage.setItem("js", jsEditor.getValue());
        }

        function loadCode() {
            if (localStorage.getItem("html")) {
                htmlEditor.setValue(localStorage.getItem("html"));
                cssEditor.setValue(localStorage.getItem("css"));
                jsEditor.setValue(localStorage.getItem("js"));
            }
        }

        function changeTheme() {
            let themes = ["default", "dracula"];
            let currentTheme = htmlEditor.getOption("theme");
            let nextTheme = themes[(themes.indexOf(currentTheme) + 1) % themes.length];
            htmlEditor.setOption("theme", nextTheme);
            cssEditor.setOption("theme", nextTheme);
            jsEditor.setOption("theme", nextTheme);
        }

        function openPreview() {
            let newWindow = window.open();
            let html = htmlEditor.getValue();
            let css = "<style>" + cssEditor.getValue() + "</style>";
            let js = "<script>" + jsEditor.getValue() + "<\/script>";
            newWindow.document.write(html + css + js);
            newWindow.document.close();
        }

        window.addEventListener("load", loadCode);
    </script>
    <script src="https://cdn.rawgit.com/beautify-web/js-beautify/v1.10.2/js/lib/beautify-html.js"></script>
    <script src="https://cdn.rawgit.com/beautify-web/js-beautify/v1.10.2/js/lib/beautify-css.js"></script>
    <script src="https://cdn.rawgit.com/beautify-web/js-beautify/v1.10.2/js/lib/beautify.js"></script>
</body>
</html>